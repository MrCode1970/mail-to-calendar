@startuml
skinparam shadowing false
skinparam monochrome true
skinparam dpi 120

start
:Обнаружено письмо;
:receivedAt = дата письма;
:now = момент запуска скрипта;

' =====================
' ШАГ 1. СОБЫТИЕ №1 (ДЛИННОЕ)
' =====================
:Старт №1 = now + 10 минут;
:Конец №1 = receivedAt + 24 часа;
:Создать событие №1 (длительное);
:Напоминания №1 (минуты до старта):
 - T-8м
 - T-6м
 - T-4м
 - T-2м
 - T-0м;
:Quiet hours НЕ применяются;
:Событие №1 не удаляется автоматически;

' =====================
' ШАГ 2. ИНИЦИАЛИЗАЦИЯ ЦЕПОЧКИ №2
' =====================
:Цепочка №2 активна, пока
предыдущее событие №2 существует;

:Базовый шаг сигналов = 1 час;
:Первый сигнал через 1 час после старта №1;
:Округлить первый сигнал до целого часа;

:Разрешённые окна (вне тихого времени):;
:Окно A = [старт №1 .. 23:00];
:Окно B = [07:00 .. конец №1];

' =====================
' ШАГ 3. ЦИКЛ УПРАВЛЕНИЯ ЦЕПОЧКОЙ №2
' =====================
repeat
  :Каждый час запускается проверка;
  if (Текущее событие №2 удалено вручную?) then (да)
    :Остановить цепочку №2;
    :Прекратить создание новых №2 и №3;
    stop
  else (нет)
    :Если пришло время нового блока №2
     (по расписанию окна A или B),
     создаём следующее событие №2;

    :Правило удаления:\n
     предыдущее событие №2 удаляется\n
     только на следующей проверке\n
     (чтобы его сигналы успели сработать);
  endif
repeat while (конец №1 ещё не наступил?)

' =====================
' ШАГ 4. БЛОКИ СОБЫТИЙ №2 (ПРИМЕР)
' =====================
' Пример при письме 09:55, старт №1 = 10:10:
' Первый сигнал -> 11:10, округление -> 12:00?
' (по правилу: первый сигнал через час
'  после старта №1, округляем к целому часу)

' Блок №2-А:
'  - старт события = 15:00
'  - напоминания за 3ч50м, 3ч, 2ч, 1ч, 0м
'  - сигналы: 11:10, 12:00, 13:00, 14:00, 15:00

' Блок №2-B:
'  - старт = 20:00
'  - сигналы: 16:00, 17:00, 18:00, 19:00, 20:00

' Блок №2-C:
'  - старт = 22:00
'  - сигналы: 21:00, 22:00

' Тихое время 23:00–07:00

' Блок №2-D:
'  - старт = 08:55
'  - напоминания: за 1ч55м, за 55м, и в момент
'  - сигналы: 07:00, 08:00, 08:55

' =====================
' ШАГ 5. СОБЫТИЕ №3 (ФИНАЛЬНОЕ)
' =====================
if (Цепочка №2 не остановлена
    и последнее событие №2 существует?) then (да)
  :Создать событие №3;
  :Старт №3 = конец №1 (receivedAt + 24h);
  :Напоминания №3 каждые 10 минут (5 шт):
   - T-40м, T-30м, T-20м, T-10м, T-0м;
  :После создания №3
   цепочка планирования завершается;
else (нет)
  :Событие №3 не создавать;
endif

stop
@enduml
